<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub 雲端檔案室</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>

    <style>
        :root {
            --primary-color: #0366d6;
            --bg-color: #f6f8fa;
            --card-bg: #ffffff;
            --text-main: #24292e;
            --border-color: #d1d5da;
            --success-color: #2ea44f;
            --error-color: #d73a49;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
        }

        .container {
            max-width: 1000px;
            margin: auto;
        }

        /* API 限制提醒樣式 */
        #api-limit-warning {
            display: none;
            background: #fff9e6;
            border: 1px solid #ffe58f;
            color: #856404;
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            animation: fadeIn 0.5s;
        }

        h1 {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 24px;
            margin-bottom: 25px;
        }

        /* 搜尋與過濾區 */
        .search-container {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .search-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .search-input-group {
            position: relative;
            flex: 1;
            min-width: 200px;
        }

        .search-input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
            outline: none;
        }

        .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(3, 102, 214, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #8c959f;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            background: #fafbfc;
            outline: none;
        }

        /* 更新日誌區 */
        .recent-box {
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.85em;
        }

        .recent-title {
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #57606a;
        }

        .commit-item {
            border-left: 3px solid var(--primary-color);
            padding-left: 12px;
            margin-bottom: 10px;
        }

        .status-tag {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: bold;
            color: white;
            margin-right: 5px;
        }

        /* 工具列 */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .breadcrumb {
            font-size: 0.9em;
            color: #586069;
        }

        .breadcrumb span {
            cursor: pointer;
            color: var(--primary-color);
            font-weight: 500;
        }

        .view-switcher {
            display: flex;
            gap: 5px;
        }

        .view-btn {
            background: #fff;
            border: 1px solid var(--border-color);
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            color: #57606a;
        }

        .view-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* 檔案列表樣式 */
        .file-list {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #e1e4e8;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-item:hover {
            background: #f1f8ff;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            overflow: hidden;
        }

        .file-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            margin-left: 15px;
        }

        /* 大圖示模式 */
        .file-list.grid-mode {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            background: transparent;
            border: none;
        }

        .file-list.grid-mode .file-item {
            flex-direction: column;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px 10px;
            text-align: center;
            height: 100%;
            box-sizing: border-box;
        }

        .file-list.grid-mode .file-info {
            flex-direction: column;
            margin-bottom: 10px;
        }

        .file-list.grid-mode .btn-group {
            flex-direction: column;
            width: 100%;
            margin: 0;
        }

        .btn {
            text-decoration: none;
            font-size: 0.8em;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #d1d5da;
            cursor: pointer;
            text-align: center;
            font-weight: 500;
            transition: 0.2s;
        }

        .download-btn {
            color: var(--primary-color);
        }

        .download-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        .preview-btn {
            background: #fafbfc;
            color: #24292e;
        }

        .preview-btn:hover {
            background: #f3f4f6;
        }

        /* 預覽視窗 */
        #preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            width: 92%;
            max-width: 950px;
            height: 85%;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            animation: modalSlide 0.3s ease-out;
        }

        @keyframes modalSlide {
            from {
                transform: translateY(30px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            background: #fff;
        }

        .close-modal {
            cursor: pointer;
            font-size: 28px;
            border: none;
            background: none;
            color: #aaa;
        }

        .close-modal:hover {
            color: #333;
        }

        .fa-folder {
            color: #54aeff;
        }

        .fa-python {
            color: #3498db;
        }

        .fa-markdown {
            color: #f1c40f;
        }

        .fa-file-pdf {
            color: #e74c3c;
        }

        .no-result {
            padding: 40px;
            text-align: center;
            color: #8c959f;
            grid-column: 1 / -1;
        }
    </style>
</head>

<body>

    <div class="container">
        <div id="api-limit-warning">
            <i class="fa-solid fa-triangle-exclamation"></i>
            <span id="limit-message"></span>
        </div>

        <h1><i class="fa-brands fa-github"></i> 檔案室</h1>

        <div class="search-container">
            <div class="search-row">
                <div class="search-input-group">
                    <i class="fa-solid fa-magnifying-glass search-icon"></i>
                    <input type="text" id="file-search" class="search-input" placeholder="搜尋檔名..."
                        oninput="handleSearch()">
                </div>
                <select id="type-filter" class="filter-select" onchange="handleSearch()">
                    <option value="all">所有類型</option>
                </select>
            </div>
            <div style="font-size: 13px; color: #57606a;">
                <label style="cursor: pointer;"><input type="checkbox" id="global-search-check"
                        onchange="onGlobalToggle()"> 搜尋全部的子資料夾</label>
            </div>
        </div>

        <div class="recent-box">
            <div class="recent-title"><i class="fa-solid fa-clock-rotate-left"></i> 最近更新動態</div>
            <div id="recent-updates">正在同步 GitHub 動態...</div>
        </div>

        <div class="controls">
            <div class="breadcrumb" id="breadcrumb">路徑: <span onclick="fetchFiles('')">root</span></div>
            <div class="view-switcher">
                <button class="view-btn active" id="btn-list" onclick="toggleView('list')"><i
                        class="fa-solid fa-list"></i></button>
                <button class="view-btn" id="btn-grid" onclick="toggleView('grid')"><i
                        class="fa-solid fa-table-cells-large"></i></button>
            </div>
        </div>

        <ul id="file-container" class="file-list">
            <li class="file-item">初始化中...</li>
        </ul>
    </div>

    <div id="preview-modal">
        <div class="modal-content">
            <div class="modal-header">
                <strong id="modal-title" style="font-size: 1.1em; color: var(--primary-color);">檔案預覽</strong>
                <button class="close-modal" onclick="closePreview()">&times;</button>
            </div>
            <div id="modal-body" class="modal-body"></div>
        </div>
    </div>

    <script>
        const REPO_OWNER = 'hsnucrc47';
        const REPO_NAME = 'python-class-zerojudge';
        let currentPath = '';
        let currentDirFiles = [];
        let allRepoFiles = [];

        // --- API 限制提醒 ---
        function checkRateLimit(response) {
            if (response.status === 403 && response.headers.get('X-RateLimit-Remaining') === '0') {
                const resetTime = new Date(response.headers.get('X-RateLimit-Reset') * 1000);
                const waitMinutes = Math.ceil((resetTime - new Date()) / 1000 / 60);
                const warningBox = document.getElementById('api-limit-warning');
                const message = document.getElementById('limit-message');
                message.innerText = `GitHub API 存取過於頻繁，目前已達上限。請於 ${waitMinutes} 分鐘後再試。`;
                warningBox.style.display = 'flex';
                return true;
            }
            return false;
        }

        function toROCDate(dateString) {
            const d = new Date(dateString);
            return `${d.getFullYear() - 1911}/${d.getMonth() + 1}/${d.getDate()} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
        }

        async function fetchRecentUpdates() {
            const updateContainer = document.getElementById('recent-updates');
            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/commits?per_page=1`);
                if (checkRateLimit(response)) return;
                const commits = await response.json();
                updateContainer.innerHTML = '';
                for (let item of commits) {
                    const detailResp = await fetch(item.url);
                    const detailData = await detailResp.json();
                    const div = document.createElement('div');
                    div.className = 'commit-item';
                    let files = detailData.files.slice(0, 2).map(f => {
                        const color = f.status === 'added' ? '#2ea44f' : '#f1c40f';
                        return `<div><span class="status-tag" style="background:${color}">${f.status === 'added' ? '新增' : '修改'}</span> ${f.filename}</div>`;
                    }).join('');
                    div.innerHTML = `<div style="font-weight:600; font-size:12px; color:#d73a49; margin-bottom:4px;">${toROCDate(item.commit.committer.date)}</div>
                <div style="font-weight:600; margin-bottom: 5px;">${item.commit.message}</div>
                <div style="font-size: 11px; color: #57606a;">${files}</div>`;
                    updateContainer.appendChild(div);
                }
            } catch (e) { updateContainer.innerHTML = '無法讀取最近更新紀錄。'; }
        }

        // --- 檔案處理核心 ---
        // --- 快取設定 ---
        const CACHE_CONFIG = {
            enabled: true,
            expiry: 5 * 60 * 1000, // 快取有效時間：5分鐘
            keyPrefix: 'github_cache_'
        };

        // --- 檔案處理核心 (含快取機制) ---
        async function fetchFiles(path = '') {
            currentPath = path;
            const container = document.getElementById('file-container');
            const searchInput = document.getElementById('file-search');
            
            // UI 狀態更新
            searchInput.value = ''; 
            document.getElementById('breadcrumb').innerHTML = `路徑: <span onclick="fetchFiles('')">root</span> / ${path.replace(/\//g, ' / ')}`;
            container.innerHTML = '<li class="file-item">載入中...</li>';

            // 1. 嘗試從快取讀取
            const cacheKey = CACHE_CONFIG.keyPrefix + (path || 'root');
            const cachedData = sessionStorage.getItem(cacheKey);

            if (CACHE_CONFIG.enabled && cachedData) {
                const { data, timestamp } = JSON.parse(cachedData);
                // 檢查快取是否過期
                if (Date.now() - timestamp < CACHE_CONFIG.expiry) {
                    console.log(`[Cache] 命中快取: ${path || 'root'}`);
                    currentDirFiles = data;
                    updateTypeFilterOptions(currentDirFiles);
                    renderFileList(currentDirFiles);
                    return; // 直接返回，不發起 fetch
                }
            }

            // 2. 若無快取或已過期，則發起 Fetch
            try {
                console.log(`[API] 發起網路請求: ${path || 'root'}`);
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`);
                
                if (checkRateLimit(response)) return;
                
                currentDirFiles = await response.json();

                // 3. 寫入快取
                if (CACHE_CONFIG.enabled) {
                    sessionStorage.setItem(cacheKey, JSON.stringify({
                        data: currentDirFiles,
                        timestamp: Date.now()
                    }));
                }

                if (!document.getElementById('global-search-check').checked) {
                    updateTypeFilterOptions(currentDirFiles);
                }
                renderFileList(currentDirFiles);
            } catch (e) { 
                container.innerHTML = '<li class="file-item" style="color:red;">讀取失敗，請稍後再試</li>'; 
            }
        }

        async function fetchFullTree() {
            const fullTreeKey = CACHE_CONFIG.keyPrefix + 'full_tree';
            const cachedFullTree = sessionStorage.getItem(fullTreeKey);

            if (cachedFullTree) {
                const { data, timestamp } = JSON.parse(cachedFullTree);
                if (Date.now() - timestamp < CACHE_CONFIG.expiry) {
                    allRepoFiles = data;
                    return allRepoFiles;
                }
            }

            try {
                const resp = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/git/trees/main?recursive=1`);
                if (checkRateLimit(resp)) return null;
                const data = await resp.json();
                
                allRepoFiles = data.tree.map(i => ({
                    name: i.path.split('/').pop(),
                    path: i.path,
                    type: i.type === 'tree' ? 'dir' : 'file',
                    download_url: `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/${i.path}`
                }));

                // 寫入全域快取
                sessionStorage.setItem(fullTreeKey, JSON.stringify({
                    data: allRepoFiles,
                    timestamp: Date.now()
                }));
                
                return allRepoFiles;
            } catch (e) { return null; }
        }

        async function handleSearch() {
            const query = document.getElementById('file-search').value.toLowerCase();
            const type = document.getElementById('type-filter').value;
            const isGlobalChecked = document.getElementById('global-search-check').checked;

            // 修正邏輯：如果搜尋框是空的且沒有過濾條件，則始終顯示「當前資料夾」內容
            if (query === '' && type === 'all') {
                renderFileList(currentDirFiles);
                return;
            }

            // 如果有輸入東西，再決定要從「全域」還是「當前資料夾」找
            const source = isGlobalChecked ? await fetchFullTree() : currentDirFiles;
            if (!source) return;

            const filtered = source.filter(f => {
                const mSearch = f.name.toLowerCase().includes(query);
                const mType = type === 'all' || f.name.toLowerCase().endsWith('.' + type);
                return mSearch && mType;
            });

            renderFileList(filtered, true, isGlobalChecked);
        }

        function onGlobalToggle() {
            const isGlobal = document.getElementById('global-search-check').checked;
            if (isGlobal) {
                fetchFullTree().then(files => {
                    if (files) updateTypeFilterOptions(files);
                    handleSearch();
                });
            } else {
                updateTypeFilterOptions(currentDirFiles);
                handleSearch();
            }
        }

        function renderFileList(data, isFiltered = false, isGlobal = false) {
            const container = document.getElementById('file-container');
            container.innerHTML = '';

            if (data.length === 0) {
                container.innerHTML = `<div class="no-result">沒有符合條件的檔案。</div>`;
                return;
            }

            // 只有在「非過濾狀態」且「非根目錄」時顯示回上一層
            if (!isFiltered && currentPath !== '') {
                const upLi = document.createElement('li');
                upLi.className = 'file-item';
                upLi.style.cursor = 'pointer';
                upLi.innerHTML = `<div class="file-info" onclick="fetchFiles('${currentPath.split('/').slice(0, -1).join('/')}')">
            <span style="font-size:18px; width:20px; text-align:center;"><i class="fa-solid fa-arrow-left"></i></span>
            <span class="file-name">.. 回上一層</span></div>`;
                container.appendChild(upLi);
            }

            data.forEach(item => {
                const li = document.createElement('li');
                li.className = 'file-item';
                const icon = getFileIcon(item.name, item.type);
                const ext = item.name.split('.').pop().toLowerCase();
                const canPreview = ['py', 'md'].includes(ext) && item.type !== 'dir';

                li.innerHTML = `
            <div class="file-info" 
                 style="${item.type === 'dir' ? 'cursor:pointer' : ''}"
                 onclick="${item.type === 'dir' ? `fetchFiles('${item.path}')` : ''}">
                <span style="font-size:18px; width:20px; text-align:center;">${icon}</span>
                <div style="overflow:hidden; margin-left:12px;">
                    <div class="file-name">${item.name}</div>
                    ${(isGlobal && item.path.includes('/')) ? `<div style="font-size:11px;color:#888">${item.path}</div>` : ''}
                </div>
            </div>
            <div class="btn-group">
                ${canPreview ? `<button class="btn preview-btn" onclick="showPreview('${item.name}', '${item.download_url}')"><i class="fa-solid fa-eye"></i> 預覽</button>` : ''}
                ${item.type !== 'dir' ? `<a href="${item.download_url}" class="btn download-btn" target="_blank"><i class="fa-solid fa-download"></i> 下載</a>` : ''}
            </div>`;
                container.appendChild(li);
            });
        }

        function updateTypeFilterOptions(files) {
            const select = document.getElementById('type-filter');
            const exts = new Set();
            files.forEach(f => { if (f.type !== 'dir') exts.add(f.name.split('.').pop().toLowerCase()); });
            let html = '<option value="all">所有類型</option>';
            Array.from(exts).sort().forEach(e => html += `<option value="${e}">${e.toUpperCase()}</option>`);
            select.innerHTML = html;
        }

        function getFileIcon(name, type) {
            if (type === 'dir') return '<i class="fa-solid fa-folder"></i>';
            const ext = name.split('.').pop().toLowerCase();
            const map = { 'py': '<i class="fa-brands fa-python"></i>', 'md': '<i class="fa-brands fa-markdown"></i>', 'pdf': '<i class="fa-solid fa-file-pdf"></i>' };
            return map[ext] || '<i class="fa-solid fa-file-alt"></i>';
        }

        async function showPreview(name, downloadUrl) {
            const modal = document.getElementById('preview-modal');
            const modalBody = document.getElementById('modal-body');
            const modalTitle = document.getElementById('modal-title');
            
            // 清空並重新設定標題列，加入複製按鈕
            modalTitle.innerHTML = `
                <span>預覽：${name}</span>
                <button id="copy-btn" class="btn" style="margin-left: 10px; font-size: 0.7em; cursor: pointer;">
                    <i class="fa-regular fa-copy"></i> 複製代碼
                </button>
            `;
            
            modalBody.innerHTML = '<div style="text-align:center; padding:50px;">載入中...</div>';
            modal.style.display = 'flex';

            try {
                const response = await fetch(downloadUrl);
                const content = await response.text();
                const ext = name.split('.').pop().toLowerCase();

                // 綁定複製事件
                document.getElementById('copy-btn').onclick = () => copyToClipboard(content);

                if (ext === 'py') {
                    modalBody.innerHTML = `<pre class="language-python"><code>${content.replace(/</g, '&lt;')}</code></pre>`;
                    Prism.highlightAllUnder(modalBody);
                } else if (ext === 'md') {
                    modalBody.innerHTML = `<div class="markdown-body">${marked.parse(content)}</div>`;
                } else {
                    modalBody.innerHTML = `<div style="padding:20px;">此檔案類型暫不支援預覽。</div>`;
                    document.getElementById('copy-btn').style.display = 'none'; // 非代碼不顯示複製
                }
            } catch (e) { 
                modalBody.innerHTML = '<div style="color:red; padding:20px;">載入失敗。</div>'; 
            }
        }
        async function copyToClipboard(text) {
        const btn = document.getElementById('copy-btn');
        try {
            await navigator.clipboard.writeText(text);
            
            // 成功回饋：變更按鈕文字與顏色
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-check"></i> 已複製！';
            btn.style.color = 'var(--success-color)';
            
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.style.color = '';
            }, 2000);
        } catch (err) {
            console.error('無法複製: ', err);
            alert('複製失敗，請手動選取內容。');
        }
    }

        function closePreview() { document.getElementById('preview-modal').style.display = 'none'; }
        function toggleView(view) {
            document.getElementById('btn-list').classList.toggle('active', view === 'list');
            document.getElementById('btn-grid').classList.toggle('active', view === 'grid');
            document.getElementById('file-container').classList.toggle('grid-mode', view === 'grid');
        }

        fetchFiles();
        fetchRecentUpdates();
    </script>

    <script src="https://hsnucrc47.github.io/python-class/js/include.js"></script>
    <script src="https://hsnucrc47.github.io/python-class/js/animation.js" type="module"></script>
    <script src="https://hsnucrc47.github.io/python-class/js/escaping_python.js"></script>
</body>

</html>